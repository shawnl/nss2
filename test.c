/*
    {1, "00000000000000000000000000000000", "", "", "000000000000000000000000",
     "66e94bd4ef8a2c3b884cfa59ca342b2e", "00000000000000000000000000000000",
     "58e2fccefa7e3061367f1d57a4e7455a", false, false},

*/

#include <stdbool.h>
#include <stdlib.h>
#include <stdio.h>

#include "gcm.h"

int main() {
    unsigned char H[128/8] = {
        0xb8, 0x3b, 0x53, 0x37, 0x08, 0xbf, 0x53, 0x5d,
        0x0a, 0xa6, 0xe5, 0x29, 0x80, 0xd5, 0x3b, 0x78,
    };
    unsigned char A[160/8] = {
        0xfe, 0xed, 0xfa, 0xce, 0xde, 0xad, 0xbe, 0xef,
        0xfe, 0xed, 0xfa, 0xce, 0xde, 0xad, 0xbe, 0xef,
        0xab, 0xad, 0xda, 0xd2,
    };
    unsigned char C[60] = {
        0x42, 0x83, 0x1e, 0xc2, 0x21, 0x77, 0x74, 0x24,
        0x4b, 0x72, 0x21, 0xb7, 0x84, 0xd0, 0xd4, 0x9c,
        0xe3, 0xaa, 0x21, 0x2f, 0x2c, 0x02, 0xa4, 0xe0,
        0x35, 0xc1, 0x7e, 0x23, 0x29, 0xac, 0xa1, 0x2e,
        0x21, 0xd5, 0x14, 0xb2, 0x54, 0x66, 0x93, 0x1c,
        0x7d, 0x8f, 0x6a, 0x5a, 0xac, 0x84, 0xaa, 0x05,
        0x1b, 0xa3, 0x0b, 0x39, 0x6a, 0x0a, 0xac, 0x97,
        0x3d, 0x58, 0xe0, 0x91,
    };
    char GHASH[16] = {
        0x69, 0x8e, 0x57, 0xf7, 0x0e, 0x6e, 0xcc, 0x7f,
        0xd9, 0x46, 0x3b, 0x72, 0x60, 0xa9, 0xae, 0x5f,
    };

    gcmHashContext ghashCtx;
    bool sw = false;
    if (SECSuccess != gcmHash_InitContext(&ghashCtx, H, sw))
        abort();
    gcmHash_Reset(&ghashCtx,
                  A,
                  sizeof(A));
    gcmHash_Update(&ghashCtx,
                   C,
                   sizeof(C));
    uint8_t result_bytes[16];
    unsigned int out_len;
    if (SECSuccess != gcmHash_Final(&ghashCtx, result_bytes, &out_len, 16))
        abort();
    if (out_len != 16)
        abort();
    if (memcmp(result_bytes, GHASH, 16) != 0)
        abort();
puts("success~!");
    return 0;
}

void PORT_SetError_stub(int f) {}
void PORT_ZAllocAlignedOffset_stub() {}
void CTR_InitContext() {}
void CTR_Update() {}
void CTR_DestroyContext() {}
void PORT_Free_stub() {}
void NSS_SecureMemcmp_stub() {}
void PORT_ZAlloc_stub() {}
